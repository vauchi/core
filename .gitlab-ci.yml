# GitLab CI for vauchi-core
#
# Core library and mobile bindings
#
# Pipelines:
#   - MR/main: lint, test, security
#   - Tags (v*): lint, test, security, build, package, publish
#
# GitLab Ultimate Features:
#   - SAST: Static application security testing
#   - Dependency Scanning: Cargo.lock vulnerability scanning
#   - Secret Detection: Prevent credential leaks
#   - License Compliance: Check dependency licenses

# GitLab Ultimate Templates
include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Dependency-Scanning.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml
  - template: Security/License-Scanning.gitlab-ci.yml

stages:
  - lint
  - test
  - security
  - build
  - package
  - publish
  - trigger

variables:
  CARGO_HOME: ${CI_PROJECT_DIR}/.cargo
  RUST_BACKTRACE: "1"

  # GitLab Ultimate Security Configuration
  SAST_EXCLUDED_PATHS: "target/, tests/fixtures/"
  DS_EXCLUDED_PATHS: "target/"
  SECRET_DETECTION_EXCLUDED_PATHS: "target/"

# ============================================================
# Templates
# ============================================================

# Rust cache for Docker runners
.rust-cache: &rust-cache
  cache:
    key: ${CI_COMMIT_REF_SLUG}-rust
    paths:
      - .cargo/bin/
      - .cargo/registry/index/
      - .cargo/registry/cache/
      - .cargo/git/db/
      - target/

# Aggressive Rust cache for self-hosted runners (includes release builds)
.rust-cache-self-hosted: &rust-cache-self-hosted
  cache:
    key: rust-${CI_COMMIT_REF_SLUG}
    paths:
      - .cargo/registry/
      - .cargo/git/
      - target/release/
    policy: pull-push

.rust-job:
  image: rust:latest
  tags:
    - docker
  <<: *rust-cache

.release-only:
  rules:
    - if: $CI_COMMIT_TAG =~ /^v/

.ci-only:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG =~ /^v/

# Self-hosted runner template using job token auth (no SSH required)
.self-hosted-job:
  variables:
    GIT_STRATEGY: clone
    GIT_DEPTH: 20
  id_tokens:
    GITLAB_OIDC_TOKEN:
      aud: https://gitlab.com

# ============================================================
# Lint Stage
# ============================================================

lint:format:
  extends: [.rust-job, .ci-only]
  stage: lint
  script:
    - rustup component add rustfmt
    - cargo fmt --all -- --check

lint:clippy:
  extends: [.rust-job, .ci-only]
  stage: lint
  script:
    - rustup component add clippy
    - cargo clippy --all-targets -- -D warnings

# ============================================================
# Test Stage
# ============================================================

test:unit:
  extends: [.rust-job, .ci-only]
  stage: test
  script:
    - cargo test --all-targets

test:coverage:
  extends: [.rust-job]
  stage: test
  before_script:
    - rustup component add llvm-tools-preview
    - cargo install cargo-llvm-cov --locked || true
  script:
    - cargo llvm-cov --workspace --lcov --output-path lcov.info
    - cargo llvm-cov report --workspace
  coverage: '/Total:\s+(\d+(?:\.\d+)?%)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: cobertura.xml
    paths:
      - lcov.info
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
  allow_failure: true

# ============================================================
# Security Stage
# ============================================================

# Override GitLab templates to run on correct events
sast:
  stage: security
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_PIPELINE_SOURCE == "schedule"

dependency_scanning:
  stage: security
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_PIPELINE_SOURCE == "schedule"

secret_detection:
  stage: security
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

license_scanning:
  stage: security
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "**/Cargo.toml"
        - "**/Cargo.lock"
    - if: $CI_COMMIT_BRANCH == "main"

# Rust-specific security checks
security:audit:
  extends: .rust-job
  stage: security
  script:
    - cargo install cargo-audit || true
    - cargo audit
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "**/Cargo.toml"
        - "**/Cargo.lock"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_PIPELINE_SOURCE == "schedule"
  allow_failure: true

security:deny:
  extends: .rust-job
  stage: security
  script:
    - cargo install cargo-deny || true
    - cargo deny check
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "**/Cargo.toml"
        - "**/Cargo.lock"
        - "deny.toml"
    - if: $CI_COMMIT_BRANCH == "main"
  allow_failure: true

# ============================================================
# Build Stage (Release only)
# ============================================================

build:ios:
  extends: [.release-only, .self-hosted-job]
  stage: build
  tags:
    - macos
    - self-hosted
  <<: *rust-cache-self-hosted
  script:
    - ./scripts/build-bindings.sh --ios
    - ./scripts/validate-bindings.sh || true
  artifacts:
    paths:
      - ../ios/Vauchi/Generated/
      - ../ios/Vauchi/Libs/
    expire_in: 1 day

build:android:
  extends: [.release-only, .self-hosted-job]
  stage: build
  tags:
    - linux
    - self-hosted
  <<: *rust-cache-self-hosted
  variables:
    # Use pre-installed NDK on VM (no download required)
    ANDROID_NDK_HOME: /opt/android-sdk/ndk/26.1.10909125
  before_script:
    # Install Rust Android targets if not present
    - rustup target add aarch64-linux-android x86_64-linux-android
  script:
    - ./scripts/build-bindings.sh --android
    - ./scripts/validate-bindings.sh || true
  artifacts:
    paths:
      - ../android/app/src/main/jniLibs/
      - ../android/app/src/main/kotlin/
    expire_in: 1 day

# ============================================================
# Package Stage (Release only)
# ============================================================

package:xcframework:
  extends: [.release-only, .self-hosted-job]
  stage: package
  tags:
    - macos
    - self-hosted
  needs:
    - build:ios
  script:
    - ./scripts/package-xcframework.sh "$CI_COMMIT_TAG"
  artifacts:
    paths:
      - dist/VauchiMobileFFI.xcframework.zip
      - dist/VauchiMobileFFI.xcframework.zip.sha256
      - dist/VauchiMobile-*.zip
    expire_in: 1 week

package:android:
  extends: [.release-only, .self-hosted-job]
  stage: package
  tags:
    - linux
    - self-hosted
  needs:
    - build:android
  script:
    - ./scripts/package-android.sh "$CI_COMMIT_TAG"
  artifacts:
    paths:
      - dist/vauchi-mobile-android-*.zip
      - dist/vauchi-mobile-android-*.zip.sha256
    expire_in: 1 week

# ============================================================
# Publish Stage (Release only)
# ============================================================

publish:packages:
  extends: [.release-only, .self-hosted-job]
  stage: publish
  tags:
    - linux
    - self-hosted
  needs:
    - package:xcframework
    - package:android
  script:
    - ./scripts/publish-packages.sh "$CI_COMMIT_TAG"

release:create:
  extends: .release-only
  stage: publish
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - publish:packages
  script:
    - echo "Creating release $CI_COMMIT_TAG"
  release:
    tag_name: $CI_COMMIT_TAG
    name: "Release $CI_COMMIT_TAG"
    description: |
      ## VauchiMobile $CI_COMMIT_TAG

      ### Downloads

      - [iOS XCFramework](${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/vauchi-mobile/${CI_COMMIT_TAG}/VauchiMobileFFI.xcframework.zip)
      - [Android](${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/vauchi-mobile/${CI_COMMIT_TAG}/vauchi-mobile-android-${CI_COMMIT_TAG}.zip)

      ### Integration

      See [documentation](https://gitlab.com/vauchi/core/-/blob/main/README.md) for integration instructions.

# ============================================================
# Trigger Stage (Release only)
# ============================================================

trigger:downstream:
  extends: [.release-only, .self-hosted-job]
  stage: trigger
  tags:
    - linux
    - self-hosted
  needs:
    - release:create
  script:
    - ./scripts/trigger-downstream.sh "$CI_COMMIT_TAG"

# ============================================================
# Manual Dev Build (on-demand)
# ============================================================

build:dev:
  extends: .self-hosted-job
  stage: build
  tags:
    - linux
    - self-hosted
  <<: *rust-cache-self-hosted
  rules:
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
  variables:
    DEV_VERSION: "dev-${CI_COMMIT_SHORT_SHA}"
    ANDROID_NDK_HOME: /opt/android-sdk/ndk/26.1.10909125
  before_script:
    - rustup target add aarch64-linux-android x86_64-linux-android
  script:
    - echo "Building dev version $DEV_VERSION"
    - ./scripts/build-bindings.sh --android
    - ./scripts/package-android.sh "$DEV_VERSION"
  artifacts:
    paths:
      - dist/
    expire_in: 3 days
